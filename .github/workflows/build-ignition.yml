name: Build Ignition

concurrency:
  group: build-ignition-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - README.md
      - .gitignore
  workflow_dispatch:
    inputs:
      version:
        description: "Fedora release version"
        required: false
        default: ""

env:
  STREAM: stable
  BUTANE_IMAGE: quay.io/coreos/butane:release
  INSTALLER_IMAGE: quay.io/coreos/coreos-installer:release
  IMAGE_NAME: ghcr.io/noobping/netboot

jobs:
  compute-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.setver.outputs.version }}
    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - id: setver
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual version supplied: $VERSION"
          else
            LATEST_TAG="$(skopeo list-tags docker://quay.io/fedora-ostree-desktops/silverblue \
              | jq -r '.Tags[]' | grep -E '^[0-9]+$' | sort -V | tail -1)"
            VERSION=$((LATEST_TAG - 1))
            echo "Auto-detected version: $VERSION"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  generate-ignition:
    needs: compute-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      VERSION: ${{ needs.compute-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          sed "s|__VERSION__|$VERSION|g" configs/silverblue.conf > ks.cfg

      - name: Generate Ignition from Butane
        run: |
          set -euo pipefail
          docker run --rm -i \
            -v "$PWD":/work -w /work \
            "$BUTANE_IMAGE" \
            --files-dir . --strict < butane/fcos.yml > fcos.ign
          ls -lh fcos.ign

      - name: Upload ignition + site files
        uses: actions/upload-artifact@v4
        with:
          name: files
          path: |
            fcos.ign
            ks.cfg
          if-no-files-found: error

  build-pxe:
    needs: generate-ignition
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download ignition artifact
        uses: actions/download-artifact@v4
        with:
          name: files
          path: .

      - name: Download FCOS live PXE artifacts
        env:
          STREAM: ${{ env.STREAM }}
          INSTALLER_IMAGE: ${{ env.INSTALLER_IMAGE }}
        run: |
          set -euo pipefail
          docker run --rm \
              --user "$(id -u):$(id -g)" \
              -v "$PWD":/work -w /work "$INSTALLER_IMAGE" \
              download -s "$STREAM" -a "${{ matrix.arch }}" -p metal -f pxe -C /work --decompress
          ls -lh

      - name: Embed Ignition into initramfs
        env:
          INSTALLER_IMAGE: ${{ env.INSTALLER_IMAGE }}
        run: |
          set -euo pipefail

          echo "Downloaded files:"
          ls -lh

          KERNEL="$(find . -maxdepth 1 -type f \( -name 'fedora-coreos-*-live-kernel.*' -o -name 'fedora-coreos-*-live-kernel*' \) | head -n1)"
          INITRAMFS="$(find . -maxdepth 1 -type f -name 'fedora-coreos-*-live-initramfs.*.img' | head -n1)"
          ROOTFS="$(find . -maxdepth 1 -type f -name 'fedora-coreos-*-live-rootfs.*.img' | head -n1)"

          if [ -z "${KERNEL}" ] || [ -z "${INITRAMFS}" ] || [ -z "${ROOTFS}" ]; then
            echo "ERROR: Could not locate one or more PXE files."
            echo "Kernel:    ${KERNEL:-<missing>}"
            echo "Initramfs: ${INITRAMFS:-<missing>}"
            echo "Rootfs:    ${ROOTFS:-<missing>}"
            exit 1
          fi

          echo "Found:"
          echo "  kernel:    $KERNEL"
          echo "  initramfs: $INITRAMFS"
          echo "  rootfs:    $ROOTFS"

          OUT_INITRAMFS="$(basename "$INITRAMFS" .img)-with-ign.img"

          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$PWD":/work -w /work "$INSTALLER_IMAGE" \
            pxe customize \
              --live-ignition fcos.ign \
              -o "${OUT_INITRAMFS}" \
              "$(basename "$INITRAMFS")"

          ARCH="$(echo "$ROOTFS" | sed -n 's/.*live-rootfs\.\(.*\)\.img/\1/p')"
          mkdir -p "pxe-${ARCH}"
          cp "$KERNEL" "pxe-${ARCH}/"
          cp "$ROOTFS" "pxe-${ARCH}/"
          cp "$OUT_INITRAMFS" "pxe-${ARCH}/"

          echo "Staged PXE files:"
          ls -lh "pxe-${ARCH}"

      - name: Generate checksums
        run: |
          (cd pxe-${{ matrix.arch }} && sha256sum * > SHA256SUMS)

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.6.0

      - name: Cosign sign PXE blobs
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          for f in pxe-${{ matrix.arch }}/*; do
            cosign sign-blob --yes "$f" --output-signature "$f.sig"
          done

      - name: Upload PXE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pxe-${{ matrix.arch }}
          path: |
            pxe-${{ matrix.arch }}/*
            pxe-${{ matrix.arch }}/*.sig
            pxe-${{ matrix.arch }}/SHA256SUMS
          if-no-files-found: error
          compression-level: 6
          overwrite: true

  boot-container:
    name: Build & Publish FCOS PXE Container
    needs: build-pxe
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download PXE artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pxe-*
          path: .

      - name: Download ignition artifact
        uses: actions/download-artifact@v4
        with:
          name: files
          path: .

      - run: tree
        continue-on-error: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.description=PXE server for Fedora CoreOS (TFTP + HTTP)
            org.opencontainers.image.title=netboot
            org.opencontainers.image.licenses="MIT"
            io.containers.autoupdate="registry"

      - name: Build & Push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          pull: true
          build-args: |
            UID=1000
            GID=1000
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-iso-fcos:
    name: Build FCOS ISOs
    needs: generate-ignition
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download ignition artifact
        uses: actions/download-artifact@v4
        with:
          name: files
          path: .

      - name: Download FCOS live ISO
        run: |
          set -euo pipefail
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$PWD":/work -w /work "$INSTALLER_IMAGE" \
            download -s "$STREAM" -a "${{ matrix.arch }}" -p metal -f iso -C /work --decompress

      - name: Customize ISO with Ignition
        run: |
          set -euo pipefail
          ARCH="${{ matrix.arch }}"
          ISO=$(ls -1 fedora-coreos-*-live-iso.${ARCH}.iso | tail -n1)

          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$PWD":/work -w /work "$INSTALLER_IMAGE" \
            iso customize \
              --live-ignition fcos.ign \
              --dest-ignition fcos.ign \
              --pre-install scripts/detect-device.sh \
              -o fcos-${ARCH}.iso \
              "${ISO}"

          ls -l fcos-${ARCH}.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: fcos-${{ matrix.arch }}.iso
          path: fcos-${{ matrix.arch }}.iso
          if-no-files-found: error
          compression-level: 6
          overwrite: true

  pages:
    needs:
      - compute-version
      - generate-ignition
      - build-iso-fcos
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: read
      packages: read
    env:
      VERSION: ${{ needs.compute-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download built artifact (ignition + site)
        uses: actions/download-artifact@v4
        with:
          name: files
          path: dist

      - name: Prepare site files
        run: |
          set -euo pipefail
          cp site/* dist/
          cp dist/fcos.ign dist/ign.json
          sed -i "s|__VERSION__|$VERSION|g" dist/index.html
      
      - name: "Download: fcos-x86_64.iso"
        uses: actions/download-artifact@v4
        with:
          name: fcos-x86_64.iso
          path: dist/fedora-coreos-$VERSION-x86_64.iso

      - name: "Download: fcos-aarch64.iso"
        uses: actions/download-artifact@v4
        with:
          name: fcos-aarch64.iso
          path: dist/fedora-coreos-$VERSION-aarch64.iso

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
